<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}"
      lang="ko">
<head>
    <title th:text="${category != null ? 'ì¹´í…Œê³ ë¦¬ ìˆ˜ì •' : 'ì¹´í…Œê³ ë¦¬ ë“±ë¡'}">ì¹´í…Œê³ ë¦¬ ë“±ë¡</title>
    <th:block layout:fragment="css">
        <style>
            .form-container {
                max-width: 800px;
                margin: 50px auto;
                padding: 40px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .form-header {
                text-align: center;
                margin-bottom: 40px;
            }
            
            .form-header h1 {
                font-size: 28px;
                font-weight: 700;
                color: #232f3e;
            }
            
            .form-group {
                margin-bottom: 25px;
            }
            
            .form-group label {
                display: block;
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
                font-size: 14px;
            }
            
            .form-group label .required {
                color: #f44336;
            }
            
            .form-control {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: all 0.3s;
                box-sizing: border-box;
            }
            
            .form-control:focus {
                outline: none;
                border-color: #ff9900;
                box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
            }
            
            .help-text {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            
            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .form-actions {
                display: flex;
                gap: 15px;
                margin-top: 40px;
                justify-content: center;
            }
            
            .btn {
                padding: 14px 40px;
                border: none;
                border-radius: 4px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-primary {
                background: #ff9900;
                color: #fff;
            }
            
            .btn-primary:hover {
                background: #e88b00;
            }
            
            .btn-secondary {
                background: #e7e9ec;
                color: #333;
            }
            
            .btn-secondary:hover {
                background: #d5d9dd;
            }
            
            .depth-info {
                padding: 15px;
                background: #e3f2fd;
                border-left: 4px solid #2196F3;
                border-radius: 4px;
                margin-bottom: 20px;
            }
            
            .depth-info p {
                margin: 5px 0;
                font-size: 14px;
                color: #1976D2;
            }
        </style>
    </th:block>
</head>
<body>
    <main layout:fragment="content">
        <div class="form-container">
            <div class="form-header">
                <h1 th:text="${category != null ? 'ì¹´í…Œê³ ë¦¬ ìˆ˜ì •' : 'ì¹´í…Œê³ ë¦¬ ë“±ë¡'}">ì¹´í…Œê³ ë¦¬ ë“±ë¡</h1>
            </div>
            
            <div class="depth-info">
                <p><strong>ğŸ“Œ ì¹´í…Œê³ ë¦¬ êµ¬ì¡° ì•ˆë‚´</strong></p>
                <p>â€¢ ëŒ€ë¶„ë¥˜: ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì—†ì´ ë“±ë¡</p>
                <p>â€¢ ì¤‘ë¶„ë¥˜: ëŒ€ë¶„ë¥˜ë¥¼ ë¶€ëª¨ë¡œ ì„ íƒ</p>
                <p>â€¢ ì†Œë¶„ë¥˜: ì¤‘ë¶„ë¥˜ë¥¼ ë¶€ëª¨ë¡œ ì„ íƒ</p>
            </div>
            
            <form th:action="${category != null ? '/category/edit/' + category.id : '/category/register'}"
                  method="post"
                  id="categoryForm"
                  enctype="multipart/form-data">
                
                <!-- ì¹´í…Œê³ ë¦¬ëª… -->
                <div class="form-group">
                    <label for="name">
                        ì¹´í…Œê³ ë¦¬ëª…<span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="name" 
                           name="name" 
                           th:value="${category?.name}"
                           placeholder="ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                           required>
                    <div class="help-text">ì˜ˆ: ìŠ¤í¬ì¸ /ë ˆì €, ëŸ¬ë‹, ëŸ¬ë‹í™”</div>
                </div>
                
                <!-- ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                <div class="form-group">
                    <label for="categoryDepth">ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜<span class="required">*</span></label>
                    <select class="form-control" id="categoryDepth" onchange="updateParentSelection()" required>
                        <option value="1">ëŒ€ë¶„ë¥˜ (ìµœìƒìœ„)</option>
                        <option value="2">ì¤‘ë¶„ë¥˜ (ëŒ€ë¶„ë¥˜ í•˜ìœ„)</option>
                        <option value="3">ì†Œë¶„ë¥˜ (ì¤‘ë¶„ë¥˜ í•˜ìœ„)</option>
                    </select>
                    <div class="help-text">ë“±ë¡í•  ì¹´í…Œê³ ë¦¬ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”</div>
                </div>
                
                <!-- ëŒ€ë¶„ë¥˜ ì„ íƒ (ì¤‘ë¶„ë¥˜/ì†Œë¶„ë¥˜ ë“±ë¡ ì‹œ) -->
                <div class="form-group" id="parentLargeGroup" style="display: none;">
                    <label for="parentLargeId">ìƒìœ„ ëŒ€ë¶„ë¥˜ ì„ íƒ<span class="required">*</span></label>
                    <select class="form-control" id="parentLargeId" onchange="loadMediumForParent()">
                        <option value="">ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option th:each="large : ${largeCategories}" 
                                th:value="${large.id}" 
                                th:text="${large.name}">
                        </option>
                    </select>
                </div>
                
                <!-- ì¤‘ë¶„ë¥˜ ì„ íƒ (ì†Œë¶„ë¥˜ ë“±ë¡ ì‹œ) -->
                <div class="form-group" id="parentMediumGroup" style="display: none;">
                    <label for="parentMediumId">ìƒìœ„ ì¤‘ë¶„ë¥˜ ì„ íƒ<span class="required">*</span></label>
                    <select class="form-control" id="parentMediumId">
                        <option value="">ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <!-- ì‹¤ì œ ì „ì†¡ë˜ëŠ” parentId (hidden) -->
                <input type="hidden" id="parentId" name="parentId">
                
                <!-- ì¹´í…Œê³ ë¦¬ ì½”ë“œ & ì •ë ¬ ìˆœì„œ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="code">ì¹´í…Œê³ ë¦¬ ì½”ë“œ</label>
                        <input type="text" 
                               class="form-control" 
                               id="code" 
                               name="code" 
                               th:value="${category?.code}"
                               placeholder="SPORTS_RUN_SHOES">
                        <div class="help-text">ì˜ë¬¸ ëŒ€ë¬¸ìì™€ ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš©</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="displayOrder">ì •ë ¬ ìˆœì„œ</label>
                        <input type="number" 
                               class="form-control" 
                               id="displayOrder" 
                               name="displayOrder" 
                               th:value="${category?.displayOrder}"
                               value="0"
                               min="0">
                        <div class="help-text">ë‚®ì„ìˆ˜ë¡ ë¨¼ì € í‘œì‹œ</div>
                    </div>
                </div>
                
                <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                <div class="form-group">
                    <label for="imageFile">ì¹´í…Œê³ ë¦¬ ì´ë¯¸ì§€ (ì„ íƒ)</label>
                    <input type="file" 
                           class="form-control" 
                           id="imageFile" 
                           name="imageFile" 
                           accept="image/*"
                           onchange="previewImage(event)">
                    <div class="help-text">ì¹´í…Œê³ ë¦¬ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš” (ìµœëŒ€ 10MB)</div>
                    
                    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="imagePreview" style="margin-top: 15px;">
                        <img th:if="${category?.imageUrl}" 
                             th:src="${category.imageUrl}" 
                             alt="í˜„ì¬ ì´ë¯¸ì§€" 
                             style="max-width: 200px; border-radius: 4px; border: 1px solid #ddd;">
                    </div>
                </div>
                
                <!-- ê¸°ì¡´ ì´ë¯¸ì§€ URL (ìˆ¨ê¹€, ìˆ˜ì • ì‹œ ìœ ì§€ìš©) -->
                <input type="hidden" 
                       id="imageUrl" 
                       name="imageUrl" 
                       th:value="${category?.imageUrl}">
                
                <!-- DepthëŠ” ìë™ ê³„ì‚° (hidden) -->
                <input type="hidden" id="depth" name="depth" th:value="${category?.depth}" value="1">
                
                <!-- ë²„íŠ¼ -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> 
                        <span th:text="${category != null ? 'ìˆ˜ì •í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'}">ë“±ë¡í•˜ê¸°</span>
                    </button>
                    <a href="/category/manage" class="btn btn-secondary">
                        <i class="fas fa-times"></i> ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </main>
    
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
            function previewImage(event) {
                const file = event.target.files[0];
                const preview = document.getElementById('imagePreview');
                
                if (file) {
                    // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        event.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 200px; border-radius: 4px; border: 1px solid #ddd;">`;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë³€ê²½ ì‹œ
            function updateParentSelection() {
                const depth = document.getElementById('categoryDepth').value;
                const parentLargeGroup = document.getElementById('parentLargeGroup');
                const parentMediumGroup = document.getElementById('parentMediumGroup');
                
                document.getElementById('depth').value = depth;
                
                // ì´ˆê¸°í™”
                parentLargeGroup.style.display = 'none';
                parentMediumGroup.style.display = 'none';
                document.getElementById('parentId').value = '';
                
                if (depth === '1') {
                    // ëŒ€ë¶„ë¥˜: ë¶€ëª¨ ì—†ìŒ
                    parentLargeGroup.style.display = 'none';
                    parentMediumGroup.style.display = 'none';
                } else if (depth === '2') {
                    // ì¤‘ë¶„ë¥˜: ëŒ€ë¶„ë¥˜ ì„ íƒ í•„ìš”
                    parentLargeGroup.style.display = 'block';
                    parentMediumGroup.style.display = 'none';
                } else if (depth === '3') {
                    // ì†Œë¶„ë¥˜: ëŒ€ë¶„ë¥˜ â†’ ì¤‘ë¶„ë¥˜ ì„ íƒ í•„ìš”
                    parentLargeGroup.style.display = 'block';
                    parentMediumGroup.style.display = 'block';
                }
            }
            
            // ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ ì¤‘ë¶„ë¥˜ ë¡œë“œ
            async function loadMediumForParent() {
                const largeCategoryId = document.getElementById('parentLargeId').value;
                const mediumSelect = document.getElementById('parentMediumId');
                const depth = document.getElementById('categoryDepth').value;
                
                // ì´ˆê¸°í™”
                mediumSelect.innerHTML = '<option value="">ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                
                if (!largeCategoryId) {
                    document.getElementById('parentId').value = '';
                    return;
                }
                
                // ì¤‘ë¶„ë¥˜ë¡œ ë“±ë¡í•˜ëŠ” ê²½ìš° - ëŒ€ë¶„ë¥˜ë¥¼ ë¶€ëª¨ë¡œ ì„¤ì •
                if (depth === '2') {
                    document.getElementById('parentId').value = largeCategoryId;
                    return;
                }
                
                // ì†Œë¶„ë¥˜ë¡œ ë“±ë¡í•˜ëŠ” ê²½ìš° - ì¤‘ë¶„ë¥˜ ëª©ë¡ ë¡œë“œ
                try {
                    const response = await fetch(`/category/api/children/${largeCategoryId}`);
                    const categories = await response.json();
                    
                    if (categories.length > 0) {
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = cat.name;
                            mediumSelect.appendChild(option);
                        });
                    } else {
                        alert('ì„ íƒí•œ ëŒ€ë¶„ë¥˜ì— ì¤‘ë¶„ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¤‘ë¶„ë¥˜ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                    }
                } catch (error) {
                    console.error('ì¤‘ë¶„ë¥˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            // ì¤‘ë¶„ë¥˜ ì„ íƒ ì‹œ parentId ì„¤ì •
            document.getElementById('parentMediumId').addEventListener('change', function() {
                const depth = document.getElementById('categoryDepth').value;
                if (depth === '3' && this.value) {
                    document.getElementById('parentId').value = this.value;
                }
            });
            
            // í¼ ì œì¶œ ì‹œ validation
            document.getElementById('categoryForm').addEventListener('submit', function(e) {
                const name = document.getElementById('name').value.trim();
                const depth = document.getElementById('categoryDepth').value;
                const parentId = document.getElementById('parentId').value;
                
                if (name.length < 2) {
                    e.preventDefault();
                    alert('ì¹´í…Œê³ ë¦¬ëª…ì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }
                
                // ì¤‘ë¶„ë¥˜/ì†Œë¶„ë¥˜ì¸ë° ë¶€ëª¨ê°€ ì„ íƒ ì•ˆ ëœ ê²½ìš°
                if (depth === '2' && !parentId) {
                    e.preventDefault();
                    alert('ìƒìœ„ ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return false;
                }
                
                if (depth === '3' && !parentId) {
                    e.preventDefault();
                    alert('ìƒìœ„ ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return false;
                }
                
                console.log('ì œì¶œ ë°ì´í„°:', {
                    name: name,
                    depth: depth,
                    parentId: parentId,
                    code: document.getElementById('code').value
                });
            });
        </script>
    </th:block>
</body>
</html>

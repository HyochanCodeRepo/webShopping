<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}"
      lang="ko">
<head>
    <title>상품 등록</title>
    <th:block layout:fragment="css">
        <style>

            .alert {
                padding: 15px 20px;
                margin-bottom: 20px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .register-container {
                max-width: 800px;
                margin: 50px auto;
                padding: 40px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .register-header {
                text-align: center;
                margin-bottom: 40px;
            }
            
            .register-header h1 {
                font-size: 28px;
                font-weight: 700;
                color: #232f3e;
                margin-bottom: 10px;
            }
            
            .register-header p {
                color: #666;
                font-size: 14px;
            }
            
            .form-group {
                margin-bottom: 25px;
            }
            
            .form-group label {
                display: block;
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
                font-size: 14px;
            }
            
            .form-group label .required {
                color: #f44336;
                margin-left: 3px;
            }
            
            .form-control {
                width: 100%;
                padding: 12px 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: all 0.3s;
                box-sizing: border-box;
            }
            
            .form-control:focus {
                outline: none;
                border-color: #ff9900;
                box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
            }
            
            .form-control.textarea {
                min-height: 120px;
                resize: vertical;
                font-family: inherit;
            }
            
            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .file-upload-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                width: 100%;
            }
            
            .file-upload-btn {
                display: inline-block;
                padding: 12px 20px;
                background: #f0f0f0;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                width: 100%;
            }
            
            .file-upload-btn:hover {
                background: #e8e8e8;
            }
            
            .file-upload-wrapper input[type=file] {
                position: absolute;
                left: -9999px;
            }
            
            .file-name {
                margin-top: 8px;
                font-size: 13px;
                color: #666;
            }
            
            .image-preview {
                margin-top: 15px;
                max-width: 300px;
                max-height: 300px;
                border: 1px solid #ddd;
                border-radius: 4px;
                overflow: hidden;
                display: none;
            }
            
            .image-preview img {
                width: 100%;
                height: auto;
                display: block;
            }
            
            .help-text {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            
            .form-actions {
                display: flex;
                gap: 15px;
                margin-top: 40px;
                justify-content: center;
            }
            
            .btn {
                padding: 14px 40px;
                border: none;
                border-radius: 4px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-primary {
                background: #ff9900;
                color: #fff;
            }
            
            .btn-primary:hover {
                background: #e88b00;
            }
            
            .btn-secondary {
                background: #e7e9ec;
                color: #333;
            }
            
            .btn-secondary:hover {
                background: #d5d9dd;
            }
            
            .error-message {
                color: #f44336;
                font-size: 13px;
                margin-top: 5px;
                display: none;
            }
            
            /* 상세 이미지 미리보기 */
            .detail-previews {
                display: flex;
                gap: 10px;
                margin-top: 15px;
                flex-wrap: wrap;
            }
            
            .detail-preview-item {
                position: relative;
                width: 100px;
                height: 100px;
                border: 2px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
                transition: all 0.3s;
            }
            
            .detail-preview-item:hover {
                border-color: #ff9900;
                transform: translateY(-2px);
            }
            
            .detail-preview-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .delete-btn {
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(227, 24, 55, 0.9);
                border: none;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            }
            
            .delete-btn:hover {
                background: rgba(227, 24, 55, 1);
                transform: scale(1.1);
            }
            
            .image-number {
                position: absolute;
                bottom: 5px;
                left: 5px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
            }
        </style>
    </th:block>
</head>
<body>
    <main layout:fragment="content">
        <div th:if="${message}" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${message}"></span>
        </div>

        <div class="register-container">
            <div class="register-header">
                <h1>상품 등록</h1>
                <p>새로운 상품 정보를 입력해주세요</p>
            </div>
            
            <form th:action="@{/product/register}" method="post" enctype="multipart/form-data" id="productForm">
                <!-- 상품명 -->
                <div class="form-group">
                    <label for="productName">
                        상품명<span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="productName" 
                           name="productName" 
                           placeholder="상품명을 입력하세요"
                           required>
                    <div class="error-message" id="productNameError"></div>
                </div>
                
                <!-- 카테고리 -->
                <div class="form-group">
                    <label for="categoryId">
                        카테고리<span class="required">*</span>
                    </label>
                    <select class="form-control" id="categoryId" name="categoryId" required>
                        <option value="">카테고리를 선택하세요</option>
                        <!-- 컨트롤러에서 카테고리 목록을 전달받아 반복 -->
                        <option th:each="category : ${categories}" 
                                th:value="${category.id}" 
                                th:text="${category.name}">
                        </option>
                    </select>
                    <div class="error-message" id="categoryError"></div>
                </div>
                
                <!-- 가격 & 할인율 -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">
                            가격<span class="required">*</span>
                        </label>
                        <input type="number"
                               class="form-control"
                               id="price"
                               name="price" 
                               placeholder="0"
                               min="0"
                               oninput="calculateDiscount()"
                               required>
                        <div class="help-text">단위: 원</div>
                        <div class="error-message" id="priceError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="discountRate">
                            할인율
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="discountRate" 
                               name="discountRate" 
                               placeholder="0"
                               min="0"
                               max="100"
                               oninput="calculateDiscount()">
                        <div class="help-text">단위: % (0-100)</div>
                        <div id="discountPrice" style="margin-top: 10px; font-size: 16px; font-weight: 600; color: #E31837;"></div>
                    </div>
                </div>
                
                <!-- 재고 수량 -->
                <div class="form-group">
                    <label for="stockQuantity">
                        재고 수량<span class="required">*</span>
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="stockQuantity" 
                           name="stockQuantity" 
                           placeholder="0"
                           min="0"
                           required>
                    <div class="help-text">단위: 개</div>
                    <div class="error-message" id="stockError"></div>
                </div>
                
                <!-- 상품 설명 -->
                <div class="form-group">
                    <label for="description">
                        상품 설명
                    </label>
                    <textarea class="form-control textarea" 
                              id="description" 
                              name="description" 
                              placeholder="상품에 대한 상세 설명을 입력하세요"></textarea>
                    <div class="help-text">최대 1000자</div>
                </div>
                
                <!-- 대표 이미지 업로드 -->
                <div class="form-group">
                    <label for="mainImageFile">
                        대표 이미지 (필수)<span class="required">*</span>
                    </label>
                    <div class="file-upload-wrapper">
                        <label for="mainImageFile" class="file-upload-btn">
                            <i class="fas fa-cloud-upload-alt"></i> 대표 이미지 선택
                        </label>
                        <input type="file" 
                               id="mainImageFile" 
                               name="mainImageFile" 
                               accept="image/*"
                               onchange="previewMainImage(event)"
                               required>
                    </div>
                    <div class="file-name" id="mainFileName">선택된 파일 없음</div>
                    <div class="help-text">권장: JPG, PNG (최대 5MB)</div>
                    
                    <div class="image-preview" id="mainImagePreview">
                        <img id="mainPreview" src="" alt="대표 이미지 미리보기">
                    </div>
                </div>
                
                <!-- 상세 이미지 업로드 -->
                <div class="form-group">
                    <label>
                        상세 이미지 (선택, 최대 4개)
                    </label>
                    <input type="file" 
                           id="detailImageInput" 
                           accept="image/*"
                           style="display: none;">
                    <button type="button" class="file-upload-btn" onclick="document.getElementById('detailImageInput').click()">
                        <i class="fas fa-plus"></i> 상세 이미지 추가
                    </button>
                    <div class="help-text">상세 이미지는 순서대로 표시됩니다</div>
                    
                    <div id="detailPreviews" class="detail-previews">
                        <!-- 상세 이미지 미리보기들이 여기 추가됨 -->
                    </div>
                </div>
                
                <!-- 버튼 -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> 등록하기
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i class="fas fa-times"></i> 취소
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <th:block layout:fragment="script">
        <script>
            // 상세 이미지 배열
            let detailImagesArray = [];
            
            // 할인가 실시간 계산
            function calculateDiscount() {
                const price = parseInt(document.getElementById('price').value) || 0;
                const discountRate = parseInt(document.getElementById('discountRate').value) || 0;
                const discountPriceElement = document.getElementById('discountPrice');
                
                if (price > 0 && discountRate > 0) {
                    const discountAmount = Math.floor(price * discountRate / 100);
                    const finalPrice = price - discountAmount;
                    
                    discountPriceElement.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <span style="font-size: 14px; color: #666;">원가: ${price.toLocaleString()}원</span>
                            <span style="font-size: 14px; color: #E31837;">할인: -${discountAmount.toLocaleString()}원</span>
                            <span style="font-size: 18px; color: #E31837; font-weight: 700;">판매가: ${finalPrice.toLocaleString()}원</span>
                        </div>
                    `;
                } else if (price > 0) {
                    discountPriceElement.innerHTML = `
                        <span style="font-size: 16px; color: #333;">판매가: ${price.toLocaleString()}원</span>
                    `;
                } else {
                    discountPriceElement.innerHTML = '';
                }
            }
            
            // 대표 이미지 미리보기
            function previewMainImage(event) {
                const file = event.target.files[0];
                const fileName = document.getElementById('mainFileName');
                const preview = document.getElementById('mainImagePreview');
                const previewImg = document.getElementById('mainPreview');
                
                if (file) {
                    fileName.textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    fileName.textContent = '선택된 파일 없음';
                    preview.style.display = 'none';
                }
            }
            
            // 상세 이미지 추가
            document.getElementById('detailImageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 최대 4개 체크
                if (detailImagesArray.length >= 4) {
                    alert('상세 이미지는 최대 4개까지만 등록 가능합니다.');
                    return;
                }
                
                // 배열에 추가
                detailImagesArray.push(file);
                
                // 미리보기 렌더링
                renderDetailPreviews();
                
                // input 초기화 (같은 파일 다시 선택 가능하게)
                e.target.value = '';
            });
            
            // 상세 이미지 미리보기 렌더링
            function renderDetailPreviews() {
                const container = document.getElementById('detailPreviews');
                container.innerHTML = '';
                
                detailImagesArray.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'detail-preview-item';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="상세${index+1}">
                            <button type="button" class="delete-btn" onclick="deleteDetailImage(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                            <span class="image-number">${index + 1}</span>
                        `;
                        container.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // 상세 이미지 삭제
            function deleteDetailImage(index) {
                // 배열에서 제거
                detailImagesArray.splice(index, 1);
                
                // 미리보기 다시 렌더링 (번호 자동 재정렬)
                renderDetailPreviews();
            }
            
            // 폼 제출 시 처리
            document.getElementById('productForm').addEventListener('submit', function(e) {
                let isValid = true;
                
                // 상품명 검사
                const productName = document.getElementById('productName').value.trim();
                if (productName.length < 2) {
                    showError('productNameError', '상품명은 2글자 이상 입력해주세요');
                    isValid = false;
                } else {
                    hideError('productNameError');
                }
                
                // 가격 검사
                const price = parseInt(document.getElementById('price').value);
                if (price < 0) {
                    showError('priceError', '가격은 0원 이상이어야 합니다');
                    isValid = false;
                } else {
                    hideError('priceError');
                }
                
                // 재고 검사
                const stock = parseInt(document.getElementById('stockQuantity').value);
                if (stock < 0) {
                    showError('stockError', '재고는 0개 이상이어야 합니다');
                    isValid = false;
                } else {
                    hideError('stockError');
                }
                
                // 카테고리 검사
                const category = document.getElementById('categoryId').value;
                if (!category) {
                    showError('categoryError', '카테고리를 선택해주세요');
                    isValid = false;
                } else {
                    hideError('categoryError');
                }
                
                // 할인율 검사
                const discountRate = parseInt(document.getElementById('discountRate').value) || 0;
                if (discountRate < 0 || discountRate > 100) {
                    alert('할인율은 0~100 사이의 값이어야 합니다.');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    return;
                }
                
                // 상세 이미지들을 hidden input들로 변환
                const form = this;
                
                // 기존 hidden inputs 제거
                const oldHiddenInputs = form.querySelectorAll('input[name="detailImageFilesHidden"]');
                oldHiddenInputs.forEach(input => input.remove());
                
                // 상세 이미지 파일들을 FormData에 추가하기 위해 새 input 생성
                detailImagesArray.forEach((file, index) => {
                    // DataTransfer 객체 사용
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.name = 'detailImageFiles';
                    input.style.display = 'none';
                    input.files = dataTransfer.files;
                    
                    form.appendChild(input);
                });
                
                // 일반 submit 진행
            });
            
            function showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            function hideError(elementId) {
                const errorElement = document.getElementById(elementId);
                errorElement.style.display = 'none';
            }
        </script>
    </th:block>
</body>
</html>

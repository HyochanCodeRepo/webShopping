<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}"
      lang="ko">
<head>
    <title>상품 상세</title>
    <th:block layout:fragment="css">
        <style>
            .detail-container {
                max-width: 1200px;
                margin: 40px auto;
                padding: 0 20px;
            }
            
            .product-detail {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 60px;
                background: #fff;
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            /* 이미지 영역 */
            .image-section {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .main-image-wrapper {
                width: 100%;
                height: 500px;
                border: 1px solid #e8e8e8;
                border-radius: 8px;
                overflow: hidden;
                background: #f7f7f7;
            }
            
            .main-image-wrapper img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }
            
            .thumbnail-images {
                display: flex;
                gap: 10px;
                overflow-x: auto;
            }
            
            .thumbnail-item {
                width: 80px;
                height: 80px;
                border: 2px solid #ddd;
                border-radius: 4px;
                overflow: hidden;
                cursor: pointer;
                flex-shrink: 0;
                transition: all 0.3s;
            }
            
            .thumbnail-item.active {
                border-color: #ff9900;
            }
            
            .thumbnail-item:hover {
                border-color: #ff9900;
            }
            
            .thumbnail-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            /* 정보 영역 */
            .info-section {
                display: flex;
                flex-direction: column;
            }
            
            .product-category {
                color: #666;
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .product-title {
                font-size: 28px;
                font-weight: 700;
                color: #232f3e;
                margin-bottom: 20px;
                line-height: 1.4;
            }
            
            .price-section {
                padding: 20px 0;
                border-top: 1px solid #e8e8e8;
                border-bottom: 1px solid #e8e8e8;
                margin-bottom: 20px;
            }
            
            .original-price {
                font-size: 16px;
                color: #999;
                text-decoration: line-through;
                margin-bottom: 8px;
            }
            
            .discount-badge {
                display: inline-block;
                background: #E31837;
                color: #fff;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 16px;
                font-weight: 700;
                margin-right: 10px;
            }
            
            .current-price {
                font-size: 32px;
                color: #E31837;
                font-weight: 700;
            }
            
            .regular-price {
                font-size: 32px;
                color: #333;
                font-weight: 700;
            }
            
            .stock-info {
                padding: 15px 0;
                font-size: 15px;
            }
            
            .stock-available {
                color: #067d62;
                font-weight: 600;
            }
            
            .stock-low {
                color: #E31837;
                font-weight: 600;
            }
            
            .stock-out {
                color: #999;
            }
            
            /* 수량 선택 영역 */
            .quantity-section {
                padding: 20px 0;
                border-bottom: 1px solid #e8e8e8;
            }
            
            /* 옵션 선택 영역 */
            .option-section {
                padding: 20px 0;
                border-bottom: 1px solid #e8e8e8;
            }
            
            .option-label {
                font-size: 15px;
                font-weight: 600;
                color: #333;
                margin-bottom: 10px;
                display: block;
            }
            
            .option-select {
                width: 100%;
                height: 45px;
                padding: 0 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 15px;
                background: #fff;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .option-select:hover {
                border-color: #ff9900;
            }
            
            .option-select:focus {
                outline: none;
                border-color: #ff9900;
            }
            
            .option-info {
                margin-top: 10px;
                padding: 10px;
                background: #f7f7f7;
                border-radius: 4px;
                font-size: 14px;
                display: none;
            }
            
            .option-info.active {
                display: block;
            }
            
            .option-stock {
                color: #067d62;
                font-weight: 600;
            }
            
            .option-price {
                color: #E31837;
                font-weight: 600;
            }
            
            .quantity-label {
                font-size: 15px;
                font-weight: 600;
                color: #333;
                margin-bottom: 10px;
                display: block;
            }
            
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .qty-btn {
                width: 40px;
                height: 40px;
                border: 1px solid #ddd;
                background: #fff;
                border-radius: 4px;
                font-size: 18px;
                font-weight: 600;
                color: #333;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .qty-btn:hover {
                background: #f7f7f7;
                border-color: #ff9900;
            }
            
            .qty-btn:disabled {
                background: #f7f7f7;
                color: #ccc;
                cursor: not-allowed;
            }
            
            .quantity-input {
                width: 80px;
                height: 40px;
                text-align: center;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 16px;
                font-weight: 600;
            }
            
            .quantity-input:focus {
                outline: none;
                border-color: #ff9900;
            }
            
            .description-section {
                margin: 20px 0;
            }
            
            .description-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 10px;
                color: #333;
            }
            
            .description-text {
                font-size: 14px;
                line-height: 1.8;
                color: #666;
                white-space: pre-wrap;
            }
            
            /* 액션 버튼 */
            .action-buttons {
                display: flex;
                gap: 15px;
                margin-top: 30px;
            }
            
            .btn {
                flex: 1;
                padding: 16px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-cart {
                background: #fff;
                color: #333;
                border: 1px solid #ddd;
            }
            
            .btn-cart:hover {
                background: #f7f7f7;
                border-color: #ff9900;
            }
            
            .btn-buy {
                background: #ff9900;
                color: #fff;
            }
            
            .btn-buy:hover {
                background: #e88b00;
            }
            
            .btn-buy:disabled,
            .btn-cart:disabled {
                background: #e8e8e8;
                color: #999;
                cursor: not-allowed;
            }
            
            /* ADMIN 전용 버튼 */
            .admin-actions {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #e8e8e8;
                display: flex;
                gap: 10px;
            }
            
            .btn-admin {
                flex: 1;
                padding: 14px;
                border: none;
                border-radius: 4px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-edit {
                background: #232f3e;
                color: #fff;
            }
            
            .btn-edit:hover {
                background: #131921;
            }
            
            .btn-delete {
                background: #fff;
                color: #E31837;
                border: 1px solid #E31837;
            }
            
            .btn-delete:hover {
                background: #E31837;
                color: #fff;
            }
            
            /* 반응형 */
            @media (max-width: 768px) {
                .product-detail {
                    grid-template-columns: 1fr;
                    gap: 30px;
                    padding: 20px;
                }
                
                .main-image-wrapper {
                    height: 400px;
                }
                
                .product-title {
                    font-size: 22px;
                }
                
                .current-price,
                .regular-price {
                    font-size: 26px;
                }
                
                .action-buttons {
                    flex-direction: column;
                }
            }
            
            /* 탭 메뉴 */
            .product-tabs {
                margin-top: 60px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .tab-nav {
                display: flex;
                border-bottom: 2px solid #e8e8e8;
            }
            
            .tab-button {
                flex: 1;
                padding: 20px;
                background: none;
                border: none;
                font-size: 16px;
                font-weight: 600;
                color: #666;
                cursor: pointer;
                transition: all 0.3s;
                position: relative;
            }
            
            .tab-button:hover {
                color: #ff9900;
            }
            
            .tab-button.active {
                color: #ff9900;
            }
            
            .tab-button.active::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 2px;
                background: #ff9900;
            }
            
            .tab-content {
                display: none;
                padding: 40px;
            }
            
            .tab-content.active {
                display: block;
            }
            
            /* 상세 정보 */
            .detail-content {
                line-height: 1.8;
                color: #333;
            }
            
            .detail-content img {
                max-width: 100%;
                height: auto;
                display: block;
                margin: 20px 0;
            }
            
            .detail-content h1, .detail-content h2, .detail-content h3 {
                margin-top: 30px;
                margin-bottom: 15px;
            }
            
            .detail-content p {
                margin-bottom: 15px;
            }
            
            .detail-content ul, .detail-content ol {
                margin-left: 20px;
                margin-bottom: 15px;
            }
            
            .empty-detail {
                text-align: center;
                padding: 60px 20px;
                color: #999;
            }
            
            .empty-detail-icon {
                font-size: 60px;
                margin-bottom: 20px;
            }
        </style>
    </th:block>
</head>
<body>
    <main layout:fragment="content">
        <div class="detail-container">
            <div class="product-detail">
                <!-- 이미지 영역 -->
                <div class="image-section">
                    <div class="main-image-wrapper">
                        <img id="mainImage" 
                             th:src="${product.repImageUrl != null ? product.repImageUrl : '/images/product-sample.jpg'}" 
                             alt="상품 이미지">
                    </div>
                    
                    <!-- 썸네일 이미지들 -->
                    <div class="thumbnail-images" th:if="${product.images.size() > 1}">
                        <div class="thumbnail-item active" 
                             th:each="image, iterStat : ${product.images}"
                             th:data-image="${image.imageUrl}"
                             onclick="changeMainImage(this)">
                            <img th:src="${image.imageUrl}" alt="썸네일">
                        </div>
                    </div>
                </div>
                
                <!-- 정보 영역 -->
                <div class="info-section">
                    <div class="product-category" th:text="${product.category.name}">카테고리</div>
                    
                    <h1 class="product-title" th:text="${product.productName}">상품명</h1>
                    
                    <!-- 평균 별점 표시 -->
                    <div class="product-rating" style="margin-bottom: 15px;">
                        <div th:if="${reviewCount > 0}" style="display: flex; align-items: center; gap: 10px;">
                            <div style="color: #ff9900; font-size: 18px;">
                                <span th:each="i : ${#numbers.sequence(1, 5)}">
                                    <i th:class="${i <= averageRating ? 'fas fa-star' : 
                                                  (i - 0.5 <= averageRating ? 'fas fa-star-half-alt' : 'far fa-star')}"></i>
                                </span>
                            </div>
                            <span style="font-size: 16px; font-weight: 600; color: #333;" 
                                  th:text="${averageRating}">4.5</span>
                            <span style="font-size: 14px; color: #666;">
                                (<span th:text="${reviewCount}">128</span>개 리뷰)
                            </span>
                        </div>
                        <div th:unless="${reviewCount > 0}" style="font-size: 14px; color: #999;">
                            <i class="far fa-star"></i> 첫 번째 리뷰를 작성해보세요!
                        </div>
                    </div>
                    
                    <!-- 가격 정보 -->
                    <div class="price-section">
                        <!-- 할인이 있을 때 -->
                        <div th:if="${product.discountRate != null and product.discountRate > 0}">
                            <div class="original-price">
                                정가: <span th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">50,000원</span>
                            </div>
                            <div>
                                <span class="discount-badge" th:text="${product.discountRate + '%'}">10%</span>
                                <span class="current-price" 
                                      th:text="${#numbers.formatInteger(product.discountPrice, 0, 'COMMA') + '원'}">
                                    45,000원
                                </span>
                            </div>
                        </div>
                        
                        <!-- 할인이 없을 때 -->
                        <div th:unless="${product.discountRate != null and product.discountRate > 0}">
                            <span class="regular-price" 
                                  th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                50,000원
                            </span>
                        </div>
                    </div>
                    
                    <!-- 재고 정보 -->
                    <div class="stock-info">
                        <span th:if="${product.stockQuantity > 10}" class="stock-available">
                            <i class="fas fa-check-circle"></i> 재고 있음
                        </span>
                        <span th:if="${product.stockQuantity > 0 and product.stockQuantity <= 10}" class="stock-low">
                            <i class="fas fa-exclamation-circle"></i> 
                            재고 <span th:text="${product.stockQuantity}">5</span>개 남음
                        </span>
                        <span th:unless="${product.stockQuantity > 0}" class="stock-out">
                            <i class="fas fa-times-circle"></i> 품절
                        </span>
                    </div>
                    
                    <!-- 옵션 선택 (옵션이 있는 경우만 표시) -->
                    <div class="option-section" th:if="${!productOptions.isEmpty()}">
                        <label class="option-label">옵션 선택 *</label>
                        <select id="optionSelect" class="option-select" onchange="selectOption()">
                            <option value="">옵션을 선택해주세요</option>
                            <option th:each="option : ${productOptions}" 
                                    th:value="${option.id}"
                                    th:data-stock="${option.stockQuantity}"
                                    th:data-price="${option.additionalPrice}"
                                    th:disabled="${option.stockQuantity <= 0}"
                                    th:text="${option.optionType + ': ' + option.optionValue + 
                                             (option.additionalPrice > 0 ? ' (+' + #numbers.formatInteger(option.additionalPrice, 0, 'COMMA') + '원)' : '') +
                                             (option.stockQuantity <= 0 ? ' [품절]' : '')}">
                                사이즈: 250
                            </option>
                        </select>
                        
                        <div id="optionInfo" class="option-info">
                            <div>
                                <i class="fas fa-box"></i> 
                                재고: <span id="optionStock" class="option-stock">0</span>개
                            </div>
                            <div id="additionalPriceInfo" style="margin-top: 5px; display: none;">
                                <i class="fas fa-plus-circle"></i> 
                                추가금액: <span id="optionPrice" class="option-price">0</span>원
                            </div>
                        </div>
                    </div>
                    
                    <!-- 수량 선택 -->
                    <div class="quantity-section" th:if="${product.stockQuantity > 0}">
                        <label class="quantity-label">수량</label>
                        <div class="quantity-controls">
                            <button type="button" class="qty-btn" onclick="decreaseQty()">-</button>
                            <input type="number" 
                                   id="quantity" 
                                   class="quantity-input"
                                   value="1" 
                                   min="1" 
                                   th:max="${product.stockQuantity}"
                                   readonly>
                            <button type="button" class="qty-btn" onclick="increaseQty()">+</button>
                        </div>
                    </div>
                    
                    <!-- 상품 설명 -->
                    <div class="description-section" th:if="${product.description != null and !product.description.isEmpty()}">
                        <div class="description-title">상품 설명</div>
                        <div class="description-text" th:text="${product.description}">상품 설명 내용</div>
                    </div>
                    
                    <!-- 일반 사용자 액션 버튼 -->
                    <div class="action-buttons">
                        <button class="btn btn-cart" 
                                th:disabled="${product.stockQuantity <= 0}"
                                onclick="addToCart()">
                            <i class="fas fa-shopping-cart"></i> 장바구니
                        </button>
                        <button class="btn btn-buy"
                                th:disabled="${product.stockQuantity <= 0}"
                                onclick="buyNow()">
                            <i class="fas fa-bolt"></i> 바로 구매
                        </button>
                    </div>
                    
                    <!-- ADMIN 전용 버튼 -->
                    <div class="admin-actions" sec:authorize="isAuthenticated()"
                        th:if="${#authentication.principal.username == product.members.email or #authorization.expression('hasRole(''ADMIN'')')}">
                        <button class="btn-admin btn-edit" 
                                th:onclick="|location.href='@{/product/edit/{id}(id=${product.id})}'|">
                            <i class="fas fa-edit"></i> 수정
                        </button>
                        <button class="btn-admin btn-delete" onclick="deleteProduct()">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 탭 메뉴 -->
            <div class="product-tabs">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchTab('detail')">
                        <i class="fas fa-info-circle"></i> 상세정보
                    </button>
                    <button class="tab-button" onclick="switchTab('review')">
                        <i class="fas fa-star"></i> 리뷰 (<span th:text="${reviewCount}">0</span>)
                    </button>
                    <button class="tab-button" onclick="switchTab('delivery')">
                        <i class="fas fa-truck"></i> 배송정보
                    </button>
                </div>
                
                <!-- 상세정보 탭 -->
                <div id="detail-tab" class="tab-content active">
                    <div th:if="${product.productDetail != null and product.productDetail.detailHtml != null and !product.productDetail.detailHtml.isEmpty()}">
                        <div class="detail-content" th:utext="${product.productDetail.detailHtml}">
                            <!-- HTML 내용이 여기 표시됨 -->
                        </div>
                    </div>
                    <div th:unless="${product.productDetail != null and product.productDetail.detailHtml != null and !product.productDetail.detailHtml.isEmpty()}">
                        <div class="empty-detail">
                            <div class="empty-detail-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <p>등록된 상세 정보가 없습니다.</p>
                        </div>
                    </div>
                </div>
                
                <!-- 리뷰 탭 -->
                <div id="review-tab" class="tab-content">
                    <!-- 리뷰 작성 버튼 -->
                    <div th:if="${canWriteReview}" style="margin-bottom: 30px;">
                        <a th:href="@{/review/write/{id}(id=${product.id})}" 
                           class="btn-action edit"
                           style="display: inline-block; padding: 12px 24px; text-decoration: none;">
                            <i class="fas fa-pen"></i> 리뷰 작성하기
                        </a>
                    </div>
                    
                    <!-- 리뷰 통계 -->
                    <div th:if="${reviewCount > 0}" style="padding: 20px; background: #f7f7f7; border-radius: 8px; margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 30px;">
                            <div>
                                <div style="font-size: 48px; font-weight: 700; color: #ff9900;" th:text="${averageRating}">4.5</div>
                                <div style="font-size: 24px; color: #ff9900;">
                                    <span th:each="i : ${#numbers.sequence(1, 5)}">
                                        <i th:class="${i <= averageRating ? 'fas fa-star' : (i - 0.5 <= averageRating ? 'fas fa-star-half-alt' : 'far fa-star')}"></i>
                                    </span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 16px; color: #666;">
                                    전체 리뷰 <strong th:text="${reviewCount}">10</strong>개
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 리뷰 목록 -->
                    <div th:if="${!reviews.isEmpty()}">
                        <div th:each="review : ${reviews}" 
                             style="padding: 25px 0; border-bottom: 1px solid #e8e8e8;">
                            <!-- 리뷰 헤더 -->
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #ff9900; margin-bottom: 5px;">
                                        <span th:each="i : ${#numbers.sequence(1, 5)}">
                                            <i th:class="${i <= review.rating ? 'fas fa-star' : 'far fa-star'}"></i>
                                        </span>
                                    </div>
                                    <div style="font-size: 14px; color: #666;">
                                        <strong th:text="${review.memberName}">작성자</strong>
                                        <span style="margin: 0 8px;">|</span>
                                        <span th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd')}">2026-01-05</span>
                                    </div>
                                </div>
                                
                                <!-- 본인 리뷰일 때 수정/삭제 버튼 -->
                                <div th:if="${currentMemberId != null and currentMemberId == review.memberId}" 
                                     style="display: flex; gap: 10px;">
                                    <a th:href="@{/review/edit/{id}(id=${review.id})}" 
                                       style="padding: 6px 12px; background: #f0f0f0; border-radius: 4px; font-size: 13px; text-decoration: none; color: #333;">
                                        <i class="fas fa-edit"></i> 수정
                                    </a>
                                    <form th:action="@{/review/delete/{id}(id=${review.id})}" 
                                          method="post" 
                                          style="display: inline;"
                                          onsubmit="return confirm('리뷰를 삭제하시겠습니까?');">
                                        <input type="hidden" name="productId" th:value="${product.id}">
                                        <button type="submit" 
                                                style="padding: 6px 12px; background: #f0f0f0; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; color: #E31837;">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- 리뷰 내용 -->
                            <div style="line-height: 1.8; color: #333; margin-bottom: 15px;" th:text="${review.content}">
                                리뷰 내용이 여기에 표시됩니다.
                            </div>
                            
                            <!-- 리뷰 이미지 -->
                            <div th:if="${review.imageUrl != null}" 
                                 style="max-width: 400px; border: 1px solid #e8e8e8; border-radius: 4px; overflow: hidden;">
                                <img th:src="${review.imageUrl}" 
                                     alt="리뷰 이미지" 
                                     style="width: 100%; height: auto; display: block;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 리뷰가 없을 때 -->
                    <div th:if="${reviews.isEmpty()}" class="empty-detail">
                        <div class="empty-detail-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <p>아직 등록된 리뷰가 없습니다.</p>
                        <p style="font-size: 14px; color: #999; margin-top: 10px;">
                            첫 번째 리뷰를 작성해보세요!
                        </p>
                    </div>
                </div>
                
                <!-- 배송정보 탭 -->
                <div id="delivery-tab" class="tab-content">
                    <div style="line-height: 1.8;">
                        <h3 style="margin-bottom: 20px;">배송 안내</h3>
                        <ul style="margin-left: 20px;">
                            <li>배송비: 3,000원 (30,000원 이상 구매 시 무료배송)</li>
                            <li>배송기간: 주문 후 2-3일 (영업일 기준)</li>
                            <li>제주/도서산간 지역: 추가 배송비 발생</li>
                        </ul>
                        
                        <h3 style="margin-top: 30px; margin-bottom: 20px;">교환/반품 안내</h3>
                        <ul style="margin-left: 20px;">
                            <li>교환/반품 가능기간: 상품 수령 후 7일 이내</li>
                            <li>교환/반품 배송비: 왕복 6,000원 (단순 변심 시)</li>
                            <li>상품 하자 시: 무료 교환/반품</li>
                        </ul>
                        
                        <h3 style="margin-top: 30px; margin-bottom: 20px;">교환/반품 불가 사유</h3>
                        <ul style="margin-left: 20px;">
                            <li>상품을 사용하거나 훼손한 경우</li>
                            <li>포장을 개봉하여 상품 가치가 감소한 경우</li>
                            <li>고객님의 책임 있는 사유로 상품이 멸실/훼손된 경우</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            const productId = /*[[${product.id}]]*/ 0;
            const maxStock = /*[[${product.stockQuantity}]]*/ 0;
            const hasOptions = /*[[${!productOptions.isEmpty()}]]*/ false;
            
            let selectedOptionId = null;
            let selectedOptionStock = 0;
            
            // 옵션 선택
            function selectOption() {
                const selectElement = document.getElementById('optionSelect');
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                
                if (selectedOption.value === '') {
                    // 옵션 선택 안 됨
                    document.getElementById('optionInfo').classList.remove('active');
                    selectedOptionId = null;
                    selectedOptionStock = 0;
                    document.getElementById('quantity').value = 1;
                    document.getElementById('quantity').max = maxStock;
                    return;
                }
                
                // 선택된 옵션 정보 저장
                selectedOptionId = parseInt(selectedOption.value);
                selectedOptionStock = parseInt(selectedOption.getAttribute('data-stock'));
                const additionalPrice = parseInt(selectedOption.getAttribute('data-price'));
                
                // 옵션 정보 표시
                document.getElementById('optionStock').textContent = selectedOptionStock;
                document.getElementById('optionPrice').textContent = additionalPrice.toLocaleString();
                
                // 추가 금액이 있으면 표시
                if (additionalPrice > 0) {
                    document.getElementById('additionalPriceInfo').style.display = 'block';
                } else {
                    document.getElementById('additionalPriceInfo').style.display = 'none';
                }
                
                document.getElementById('optionInfo').classList.add('active');
                
                // 수량 입력란 max 값 업데이트
                document.getElementById('quantity').max = selectedOptionStock;
                document.getElementById('quantity').value = 1;
            }
            
            // 수량 감소
            function decreaseQty() {
                const qtyInput = document.getElementById('quantity');
                let currentQty = parseInt(qtyInput.value);
                
                if (currentQty > 1) {
                    qtyInput.value = currentQty - 1;
                }
            }
            
            // 수량 증가
            function increaseQty() {
                const qtyInput = document.getElementById('quantity');
                let currentQty = parseInt(qtyInput.value);
                
                // 옵션이 있으면 선택된 옵션 재고, 없으면 상품 재고
                const stockLimit = hasOptions && selectedOptionId ? selectedOptionStock : maxStock;
                
                if (currentQty < stockLimit) {
                    qtyInput.value = currentQty + 1;
                } else {
                    alert('재고 수량을 초과할 수 없습니다.');
                }
            }
            
            // 장바구니 추가
            async function addToCart() {
                // 로그인 체크
                const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
                
                if (!isAuthenticated) {
                    if (confirm('로그인이 필요한 서비스입니다.\n로그인 페이지로 이동하시겠습니까?')) {
                        location.href = '/members/login';
                    }
                    return;
                }
                
                // 옵션이 있는데 선택 안 했으면
                if (hasOptions && !selectedOptionId) {
                    alert('옵션을 선택해주세요.');
                    return;
                }
                
                const quantity = parseInt(document.getElementById('quantity').value);
                
                try {
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            productId: productId,
                            productOptionId: selectedOptionId,  // 옵션 ID 추가
                            quantity: quantity
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // ✅ 장바구니 개수 업데이트
                        await updateCartCount();
                        
                        if (confirm(result.message + '\n장바구니로 이동하시겠습니까?')) {
                            location.href = '/cart';
                        }
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('장바구니 추가 중 오류가 발생했습니다.');
                }
            }
            
            // 장바구니 개수 업데이트 함수
            async function updateCartCount() {
                try {
                    const response = await fetch('/cart/count');
                    const data = await response.json();
                    const count = data.count || 0; // CartRestController는 {count: n} 형식 반환
                    
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = count;
                        
                        // 애니메이션 효과
                        cartCountElement.style.transform = 'scale(1.3)';
                        cartCountElement.style.transition = 'transform 0.2s';
                        setTimeout(() => {
                            cartCountElement.style.transform = 'scale(1)';
                        }, 200);
                    }
                } catch (error) {
                    console.error('장바구니 개수 업데이트 실패:', error);
                }
            }
            
            // 바로 구매하기
            async function buyNow() {
                // 로그인 체크
                const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
                
                if (!isAuthenticated) {
                    if (confirm('로그인이 필요한 서비스입니다.\n로그인 페이지로 이동하시겠습니까?')) {
                        location.href = '/members/login';
                    }
                    return;
                }
                
                // 옵션이 있는데 선택 안 했으면
                if (hasOptions && !selectedOptionId) {
                    alert('옵션을 선택해주세요.');
                    return;
                }
                
                const quantity = parseInt(document.getElementById('quantity').value);
                
                try {
                    // 장바구니에 먼저 추가
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            productId: productId,
                            productOptionId: selectedOptionId,  // 옵션 ID 추가
                            quantity: quantity
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 주문 페이지로 이동 (추후 구현)
                        location.href = '/order/checkout';
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('주문 처리 중 오류가 발생했습니다.');
                }
            }
            
            // 메인 이미지 변경
            function changeMainImage(element) {
                const imageUrl = element.getAttribute('data-image');
                document.getElementById('mainImage').src = imageUrl;
                
                // 썸네일 active 클래스 변경
                document.querySelectorAll('.thumbnail-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            // 상품 삭제
            function deleteProduct() {
                if (confirm('정말로 이 상품을 삭제하시겠습니까?')) {
                    location.href = '/product/delete/' + productId;
                }
            }
            
            // 탭 전환
            function switchTab(tabName) {
                // 모든 탭 버튼 비활성화
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                // 모든 탭 내용 숨김
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 선택한 탭 활성화
                event.target.classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
            }
        </script>
    </th:block>
</body>
</html>

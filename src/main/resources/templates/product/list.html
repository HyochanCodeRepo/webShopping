<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}"
      lang="ko">
<head>
    <title th:text="${categoryName}">상품 목록</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/product-list.css}">
        <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    </th:block>
</head>
<body>
<main layout:fragment="content">
    <div class="product-list-container">
        <!-- ========== 사이드바 필터 ========== -->
        <aside class="sidebar">
            <!-- 카테고리 필터 -->
            <div class="filter-section">
                <h3 class="filter-title">카테고리</h3>
                <ul class="category-tree">
                    <li th:each="large : ${globalCategories}">
                        <!-- 대분류 -->
                        <a th:href="@{/product/list(categoryId=${large.id})}" 
                           class="category-large"
                           th:classappend="${categoryId == large.id} ? 'active' : ''">
                            <span th:text="${large.name}">스포츠/레저</span>
                        </a>
                        
                        <!-- 중분류 -->
                        <ul class="category-medium-list" th:if="${!large.children.isEmpty()}">
                            <li th:each="medium : ${large.children}">
                                <a th:href="@{/product/list(categoryId=${medium.id})}"
                                   class="category-medium"
                                   th:classappend="${categoryId == medium.id} ? 'active' : ''">
                                    <span th:text="${medium.name}">러닝</span>
                                </a>
                                
                                <!-- 소분류 -->
                                <ul class="category-small-list" th:if="${!medium.children.isEmpty()}">
                                    <li th:each="small : ${medium.children}">
                                        <a th:href="@{/product/list(categoryId=${small.id})}"
                                           class="category-small"
                                           th:classappend="${categoryId == small.id} ? 'active' : ''">
                                            <span th:text="${small.name}">러닝화</span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- 가격 필터 -->
            <div class="filter-section">
                <h3 class="filter-title">가격대</h3>
                <ul class="price-filter-list">
                    <li class="price-filter-item">
                        <label th:classappend="${minPrice == 0 and maxPrice == 50000} ? 'active' : ''">
                            <input type="checkbox" 
                                   th:checked="${minPrice == 0 and maxPrice == 50000}"
                                   onchange="filterByPrice(0, 50000, this.checked)">
                            <span>0 - 50,000원</span>
                        </label>
                    </li>
                    <li class="price-filter-item">
                        <label th:classappend="${minPrice == 50000 and maxPrice == 100000} ? 'active' : ''">
                            <input type="checkbox" 
                                   th:checked="${minPrice == 50000 and maxPrice == 100000}"
                                   onchange="filterByPrice(50000, 100000, this.checked)">
                            <span>50,000 - 100,000원</span>
                        </label>
                    </li>
                    <li class="price-filter-item">
                        <label th:classappend="${minPrice == 100000 and maxPrice == 150000} ? 'active' : ''">
                            <input type="checkbox" 
                                   th:checked="${minPrice == 100000 and maxPrice == 150000}"
                                   onchange="filterByPrice(100000, 150000, this.checked)">
                            <span>100,000 - 150,000원</span>
                        </label>
                    </li>
                    <li class="price-filter-item">
                        <label th:classappend="${minPrice == 150000 and maxPrice == 200000} ? 'active' : ''">
                            <input type="checkbox" 
                                   th:checked="${minPrice == 150000 and maxPrice == 200000}"
                                   onchange="filterByPrice(150000, 200000, this.checked)">
                            <span>150,000 - 200,000원</span>
                        </label>
                    </li>
                    <li class="price-filter-item">
                        <label th:classappend="${minPrice == 200000 and maxPrice == null} ? 'active' : ''">
                            <input type="checkbox" 
                                   th:checked="${minPrice == 200000 and maxPrice == null}"
                                   onchange="filterByPrice(200000, null, this.checked)">
                            <span>200,000원 이상</span>
                        </label>
                    </li>
                </ul>
            </div>

            <!-- 색상 필터 (예시 - 나중에 구현) -->
            <div class="filter-section" style="display: none;">
                <h3 class="filter-title">색상</h3>
                <div class="color-filter-grid">
                    <div class="color-item">
                        <div class="color-circle" style="background: #000;"></div>
                        <span class="color-label">블랙</span>
                    </div>
                    <div class="color-item">
                        <div class="color-circle" style="background: #4A90E2;"></div>
                        <span class="color-label">블루</span>
                    </div>
                    <div class="color-item">
                        <div class="color-circle" style="background: #8B4513;"></div>
                        <span class="color-label">브라운</span>
                    </div>
                    <div class="color-item">
                        <div class="color-circle" style="background: #7CB342;"></div>
                        <span class="color-label">그린</span>
                    </div>
                    <div class="color-item">
                        <div class="color-circle" style="background: #9E9E9E;"></div>
                        <span class="color-label">그레이</span>
                    </div>
                    <div class="color-item">
                        <div class="color-circle" style="background: linear-gradient(45deg, #000 50%, #fff 50%);"></div>
                        <span class="color-label">멀티컬러</span>
                    </div>
                </div>
            </div>

            <!-- 필터 초기화 -->
            <div class="filter-reset" th:if="${minPrice != null or maxPrice != null}">
                <button class="btn-reset" onclick="resetFilters()">
                    필터 초기화
                </button>
            </div>
        </aside>
        
        <!-- ========== 메인 컨텐츠 ========== -->
        <div class="content-area">
            <!-- 헤더 (일반 모드) -->
            <div class="list-header" th:if="${isSearchMode == null or !isSearchMode}">
                <h1 class="category-title" th:text="${categoryName}">카테고리명</h1>
                <p class="category-subtitle">
                    <span class="product-count" th:text="${productPage != null ? productPage.totalElements : products.size()}">0</span>개의 상품
                </p>
            </div>
            
            <!-- 헤더 (검색 모드) -->
            <div class="list-header" th:if="${isSearchMode != null and isSearchMode}">
                <h1 class="category-title">
                    "<span th:text="${keyword}">검색어</span>" 검색 결과
                </h1>
                <p class="category-subtitle">
                    <span class="product-count" th:text="${productPage != null ? productPage.totalElements : products.size()}">0</span>개의 상품
                </p>
            </div>

            <!-- 정렬 바 -->
            <div class="sort-bar" th:unless="${products.isEmpty()}">
                <div class="sort-options">
                    <button class="sort-btn" 
                            th:classappend="${sortBy == null or sortBy == 'latest'} ? 'active' : ''"
                            onclick="changeSortOrder('latest')">
                        최신순
                    </button>
                    <button class="sort-btn" 
                            th:classappend="${sortBy == 'price_asc'} ? 'active' : ''"
                            onclick="changeSortOrder('price_asc')">
                        가격 낮은순
                    </button>
                    <button class="sort-btn" 
                            th:classappend="${sortBy == 'price_desc'} ? 'active' : ''"
                            onclick="changeSortOrder('price_desc')">
                        가격 높은순
                    </button>
                    <button class="sort-btn" 
                            th:classappend="${sortBy == 'popular'} ? 'active' : ''"
                            onclick="changeSortOrder('popular')">
                        인기순
                    </button>
                </div>
            </div>

            <!-- 빈 목록 -->
            <div class="empty-list" th:if="${products.isEmpty()}">
                <div class="empty-icon">
                    <i class="fas fa-box-open" th:if="${isSearchMode == null or !isSearchMode}"></i>
                    <i class="fas fa-search" th:if="${isSearchMode != null and isSearchMode}"></i>
                </div>
                <p class="empty-text" th:if="${isSearchMode == null or !isSearchMode}">
                    이 카테고리에는 아직 상품이 없습니다.
                </p>
                <p class="empty-text" th:if="${isSearchMode != null and isSearchMode}">
                    "<span th:text="${keyword}"></span>"에 대한 검색 결과가 없습니다.
                </p>
                <a th:href="@{/}" class="btn-home">
                    <i class="fas fa-home"></i>
                    <span>홈으로 이동</span>
                </a>
            </div>

            <!-- 상품 그리드 -->
            <div class="product-grid" th:unless="${products.isEmpty()}">
                <div class="product-card"
                     th:each="product : ${products}"
                     th:onclick="|location.href='@{/product/detail/{id}(id=${product.id})}'|">

                    <!-- 상품 이미지 -->
                    <div class="product-image-wrapper">
                        <!-- 품절 오버레이 -->
                        <div class="sold-out-overlay" th:if="${product.stockQuantity <= 0}">
                            <span class="sold-out-text">품절</span>
                        </div>

                        <img class="product-image"
                             th:src="${product.repImageUrl}"
                             th:alt="${product.productName}"
                             onerror="this.src='/images/product-sample.jpg'">
                    </div>

                    <!-- 상품 정보 -->
                    <div class="product-info">
                        <div class="product-category" th:text="${product.category.name}">
                            카테고리
                        </div>
                        
                        <h3 class="product-name" th:text="${product.productName}">
                            상품명
                        </h3>

                        <!-- 가격 -->
                        <div class="price-section">
                            <!-- 할인이 있을 때 -->
                            <div th:if="${product.discountRate != null and product.discountRate > 0}">
                                <div class="price-wrapper">
                                    <span class="sale-price"
                                          th:text="${#numbers.formatInteger(product.discountPrice, 0, 'COMMA') + '원'}">
                                        45,000원
                                    </span>
                                    <span class="discount-rate"
                                          th:text="${product.discountRate + '%'}">
                                        10%
                                    </span>
                                </div>
                                <div class="original-price"
                                     th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                    50,000원
                                </div>
                            </div>

                            <!-- 할인이 없을 때 -->
                            <div th:unless="${product.discountRate != null and product.discountRate > 0}">
                                <span class="regular-price"
                                      th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                    50,000원
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 페이지네이션 -->
            <div class="pagination-wrapper" th:if="${productPage != null and productPage.totalPages > 0}">
                <ul class="pagination">
                    <!-- 이전 버튼 -->
                    <li class="page-item" th:classappend="${productPage.first} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${productPage.number - 1}
                           )}"
                           th:if="${!productPage.first}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <span class="page-link" th:if="${productPage.first}">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    </li>
                    
                    <!-- 페이지 번호들 -->
                    <li class="page-item" 
                        th:each="pageNum : ${#numbers.sequence(0, productPage.totalPages - 1)}"
                        th:if="${pageNum >= (productPage.number - 2) and pageNum <= (productPage.number + 2)}"
                        th:classappend="${pageNum == productPage.number} ? 'active'">
                        <a class="page-link" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${pageNum}
                           )}"
                           th:text="${pageNum + 1}">1</a>
                    </li>
                    
                    <!-- 다음 버튼 -->
                    <li class="page-item" th:classappend="${productPage.last} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${productPage.number + 1}
                           )}"
                           th:if="${!productPage.last}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        <span class="page-link" th:if="${productPage.last}">
                            <i class="fas fa-chevron-right"></i>
                        </span>
                    </li>
                </ul>
                
                <div class="page-info">
                    <span th:text="${productPage.number + 1}">1</span> / 
                    <span th:text="${productPage.totalPages}">10</span> 
                </div>
            </div>
        </div>
    </div>
</main>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        // Thymeleaf 변수
        const isSearchMode = /*[[${isSearchMode}]]*/ false;
        const currentKeyword = /*[[${keyword}]]*/ '';
        const currentCategoryId = /*[[${categoryId}]]*/ null;
        const currentSortBy = /*[[${sortBy}]]*/ 'latest';
        const currentMinPrice = /*[[${minPrice}]]*/ null;
        const currentMaxPrice = /*[[${maxPrice}]]*/ null;
        
        // 정렬 변경
        function changeSortOrder(sortBy) {
            let url = buildUrl();
            url += '&sortBy=' + sortBy;
            window.location.href = url;
        }
        
        // 가격 필터
        function filterByPrice(minPrice, maxPrice, checked) {
            if (checked) {
                let url = buildUrl();
                url += '&minPrice=' + minPrice;
                if (maxPrice !== null) {
                    url += '&maxPrice=' + maxPrice;
                }
                window.location.href = url;
            } else {
                resetFilters();
            }
        }
        
        // URL 빌드
        function buildUrl() {
            let url = '';
            
            if (isSearchMode) {
                url = '/product/search?keyword=' + encodeURIComponent(currentKeyword);
                if (currentCategoryId) {
                    url += '&categoryId=' + currentCategoryId;
                }
            } else {
                url = '/product/list?categoryId=' + currentCategoryId;
            }
            
            return url;
        }
        
        // 필터 초기화
        function resetFilters() {
            let url = buildUrl();
            url += '&sortBy=' + currentSortBy;
            window.location.href = url;
        }
    </script>
</th:block>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}"
      lang="ko">
<head>
    <title th:text="${categoryName}">상품 목록</title>
    <th:block layout:fragment="css">
        <style>
            .product-list-container {
                max-width: 1400px;
                margin: 40px auto;
                padding: 0 20px;
                display: flex;
                gap: 30px;
            }

            /* ========== 사이드바 ========== */
            .sidebar {
                flex: 0 0 250px;
                background: #fff;
                border-radius: 8px;
                padding: 20px;
                height: fit-content;
                position: sticky;
                top: 120px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .sidebar-title {
                font-size: 18px;
                font-weight: 700;
                color: #232f3e;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #E31837;
            }

            /* 카테고리 트리 */
            .category-tree {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .category-tree > li {
                margin-bottom: 20px;
            }

            /* 대분류 */
            .category-large {
                font-size: 15px;
                font-weight: 700;
                color: #E31837;
                padding: 10px;
                display: block;
                border-radius: 4px;
                transition: all 0.2s;
            }

            .category-large:hover {
                background: #fff3f3;
            }

            .category-large.active {
                background: #E31837;
                color: #fff;
            }

            /* 중분류 */
            .category-medium-list {
                list-style: none;
                padding-left: 15px;
                margin-top: 10px;
            }

            .category-medium {
                font-size: 14px;
                font-weight: 600;
                color: #555;
                padding: 8px 10px;
                display: block;
                border-radius: 4px;
                transition: all 0.2s;
            }

            .category-medium:hover {
                background: #f5f5f5;
                color: #E31837;
                padding-left: 15px;
            }

            .category-medium.active {
                background: #fff3f3;
                color: #E31837;
                font-weight: 700;
            }

            /* 소분류 */
            .category-small-list {
                list-style: none;
                padding-left: 15px;
                margin-top: 5px;
            }

            .category-small {
                font-size: 13px;
                color: #777;
                padding: 6px 10px;
                display: block;
                border-radius: 4px;
                transition: all 0.2s;
            }
            
            .category-small:hover {
                background: #f5f5f5;
                color: #E31837;
                padding-left: 15px;
            }
            
            .category-small.active {
                background: #fff3f3;
                color: #E31837;
                font-weight: 600;
            }
            
            /* ========== 메인 컨텐츠 ========== */
            .content-area {
                flex: 1;
            }

            /* 헤더 */
            .category-header {
                padding: 30px 0;
                border-bottom: 2px solid #e8e8e8;
                margin-bottom: 40px;
            }

            .category-title {
                font-size: 32px;
                font-weight: 700;
                color: #232f3e;
                margin-bottom: 10px;
            }

            .category-subtitle {
                font-size: 16px;
                color: #666;
            }

            .product-count {
                color: #ff9900;
                font-weight: 600;
            }

            /* 정렬 옵션 */
            .sort-section {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding: 15px 20px;
                background: #f7f7f7;
                border-radius: 8px;
            }

            .sort-label {
                font-size: 14px;
                color: #666;
                margin-right: 10px;
            }

            .sort-select {
                padding: 8px 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                background: #fff;
            }
            
            .sort-select:focus {
                outline: none;
                border-color: #ff9900;
            }
            
            /* 가격 필터 */
            .price-filter {
                margin-bottom: 30px;
                padding: 20px;
                background: #fff;
                border: 1px solid #e8e8e8;
                border-radius: 8px;
            }
            
            .filter-title {
                font-size: 15px;
                font-weight: 700;
                color: #232f3e;
                margin-bottom: 15px;
            }
            
            .price-buttons {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .price-btn {
                padding: 10px 20px;
                border: 2px solid #ddd;
                background: #fff;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                color: #666;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .price-btn:hover {
                border-color: #ff9900;
                color: #ff9900;
            }
            
            .price-btn.active {
                border-color: #ff9900;
                background: #ff9900;
                color: #fff;
            }
            
            .btn-clear-filter {
                padding: 10px 20px;
                border: 2px solid #E31837;
                background: #fff;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                color: #E31837;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-clear-filter:hover {
                background: #E31837;
                color: #fff;
            }
            

            /* 상품 그리드 */
            .product-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 25px;
                margin-bottom: 50px;
            }

            /* 상품 카드 */
            .product-card {
                background: #fff;
                border: 1px solid #e8e8e8;
                border-radius: 8px;
                overflow: hidden;
                transition: all 0.3s;
                cursor: pointer;
                position: relative;
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.1);
                border-color: #ff9900;
            }

            /* 상품 이미지 */
            .product-image-wrapper {
                width: 100%;
                height: 280px;
                overflow: hidden;
                background: #f7f7f7;
                position: relative;
            }

            .product-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s;
            }

            .product-card:hover .product-image {
                transform: scale(1.05);
            }

            /* 할인 뱃지 */
            .discount-badge {
                position: absolute;
                top: 10px;
                left: 10px;
                background: #E31837;
                color: #fff;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: 700;
                z-index: 1;
            }

            /* 품절 오버레이 */
            .sold-out-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2;
            }

            .sold-out-text {
                color: #fff;
                font-size: 24px;
                font-weight: 700;
            }

            /* 상품 정보 */
            .product-info {
                padding: 20px;
            }

            .product-name {
                font-size: 16px;
                font-weight: 600;
                color: #232f3e;
                margin-bottom: 10px;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                line-height: 1.4;
                min-height: 44px;
            }

            /* 가격 */
            .price-section {
                margin-top: 10px;
            }

            .original-price {
                font-size: 14px;
                color: #999;
                text-decoration: line-through;
                margin-bottom: 5px;
            }

            .price-wrapper {
                display: flex;
                align-items: baseline;
                gap: 8px;
            }

            .discount-rate {
                font-size: 18px;
                font-weight: 700;
                color: #E31837;
            }

            .sale-price {
                font-size: 20px;
                font-weight: 700;
                color: #E31837;
            }

            .regular-price {
                font-size: 20px;
                font-weight: 700;
                color: #232f3e;
            }

            /* 재고 상태 */
            .stock-status {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #f0f0f0;
                font-size: 13px;
            }

            .stock-available {
                color: #067d62;
            }

            .stock-low {
                color: #ff9900;
            }

            /* 빈 목록 */
            .empty-list {
                text-align: center;
                padding: 80px 20px;
                background: #fff;
                border-radius: 8px;
            }

            .empty-icon {
                font-size: 80px;
                color: #ddd;
                margin-bottom: 20px;
            }

            .empty-text {
                font-size: 18px;
                color: #666;
                margin-bottom: 30px;
            }

            .btn-home {
                display: inline-block;
                padding: 14px 30px;
                background: #ff9900;
                color: #fff;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.3s;
            }

            .btn-home:hover {
                background: #e88b00;
            }

            /* 반응형 */
            @media (max-width: 1200px) {
                .product-list-container {
                    flex-direction: column;
                }
                
                .sidebar {
                    flex: none;
                    width: 100%;
                    position: static;
                }
                
                .product-grid {
                    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                }
            }

            @media (max-width: 768px) {
                .category-title {
                    font-size: 24px;
                }

                .product-grid {
                    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                    gap: 15px;
                }

                .product-image-wrapper {
                    height: 180px;
                }

                .product-info {
                    padding: 15px;
                }

                .product-name {
                    font-size: 14px;
                    min-height: 40px;
                }

                .sale-price,
                .regular-price {
                    font-size: 16px;
                }
            }
            
            /* ========== 페이지네이션 ========== */
            .pagination-wrapper {
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 50px 0;
                gap: 10px;
            }
            
            .pagination {
                display: flex;
                gap: 5px;
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            .page-item {
                display: inline-block;
            }
            
            .page-link {
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 40px;
                height: 40px;
                padding: 0 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: #fff;
                color: #333;
                font-size: 14px;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.3s;
                cursor: pointer;
            }
            
            .page-link:hover {
                border-color: #ff9900;
                color: #ff9900;
                background: #fff9f0;
            }
            
            .page-item.active .page-link {
                background: #ff9900;
                border-color: #ff9900;
                color: #fff;
            }
            
            .page-item.disabled .page-link {
                opacity: 0.5;
                cursor: not-allowed;
                pointer-events: none;
            }
            
            .page-prev,
            .page-next {
                font-weight: 700;
            }
            
            .page-info {
                margin-left: 20px;
                font-size: 14px;
                color: #666;
            }
        </style>
    </th:block>
</head>
<body>
<main layout:fragment="content">
    <div class="product-list-container">
        <!-- ========== 사이드바 카테고리 트리 ========== -->
        <aside class="sidebar">
            <h2 class="sidebar-title">카테고리</h2>
            <ul class="category-tree">
                <li th:each="large : ${globalCategories}">
                    <!-- 대분류 -->
                    <a th:href="@{/product/list(categoryId=${large.id})}" 
                       class="category-large"
                       th:classappend="${categoryId == large.id} ? 'active' : ''">
                        <i class="fas fa-folder"></i>
                        <span th:text="${large.name}">스포츠/레저</span>
                    </a>
                    
                    <!-- 중분류 -->
                    <ul class="category-medium-list" th:if="${!large.children.isEmpty()}">
                        <li th:each="medium : ${large.children}">
                            <a th:href="@{/product/list(categoryId=${medium.id})}"
                               class="category-medium"
                               th:classappend="${categoryId == medium.id} ? 'active' : ''">
                                <i class="fas fa-angle-right"></i>
                                <span th:text="${medium.name}">러닝</span>
                            </a>
                            
                            <!-- 소분류 -->
                            <ul class="category-small-list" th:if="${!medium.children.isEmpty()}">
                                <li th:each="small : ${medium.children}">
                                    <a th:href="@{/product/list(categoryId=${small.id})}"
                                       class="category-small"
                                       th:classappend="${categoryId == small.id} ? 'active' : ''">
                                        <span th:text="${small.name}">러닝화</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </aside>
        
        <!-- ========== 메인 컨텐츠 영역 ========== -->
        <div class="content-area">
            <!-- 카테고리 헤더 (일반 모드) -->
            <div class="category-header" th:if="${isSearchMode == null or !isSearchMode}">
                <h1 class="category-title" th:text="${categoryName}">카테고리명</h1>
                <p class="category-subtitle">
                    총 <span class="product-count" th:text="${products.size()}">0</span>개의 상품
                </p>
            </div>
            
            <!-- 검색 결과 헤더 (검색 모드) -->
            <div class="category-header" th:if="${isSearchMode != null and isSearchMode}">
                <h1 class="category-title">
                    "<span style="color: #E31837;" th:text="${keyword}">검색어</span>" 검색 결과
                </h1>
                <p class="category-subtitle">
                    총 <span class="product-count" th:text="${products.size()}">0</span>개의 상품이 검색되었습니다.
                </p>
                <p class="category-subtitle" th:if="${categoryId != null and categoryId > 0}" style="font-size: 14px; color: #888; margin-top: 5px;">
                    <i class="fas fa-filter"></i> 카테고리: <span th:text="${categoryName}">전체</span>
                </p>
            </div>

            <!-- 가격 필터 (항상 표시) -->
            <div class="price-filter">
                <h3 class="filter-title"><i class="fas fa-filter"></i> 가격 필터</h3>
                <div class="price-buttons">
                    <button class="price-btn" 
                            th:classappend="${minPrice == null and maxPrice == null} ? 'active' : ''"
                            onclick="filterByPrice(null, null)">
                        전체
                    </button>
                    <button class="price-btn" 
                            th:classappend="${minPrice == 0 and maxPrice == 10000} ? 'active' : ''"
                            onclick="filterByPrice(0, 10000)">
                        1만원 이하
                    </button>
                    <button class="price-btn" 
                            th:classappend="${minPrice == 10000 and maxPrice == 30000} ? 'active' : ''"
                            onclick="filterByPrice(10000, 30000)">
                        1만원 - 3만원
                    </button>
                    <button class="price-btn" 
                            th:classappend="${minPrice == 30000 and maxPrice == 50000} ? 'active' : ''"
                            onclick="filterByPrice(30000, 50000)">
                        3만원 - 5만원
                    </button>
                    <button class="price-btn" 
                            th:classappend="${minPrice == 50000 and maxPrice == null} ? 'active' : ''"
                            onclick="filterByPrice(50000, null)">
                        5만원 이상
                    </button>
                    <button class="btn-clear-filter" 
                            th:if="${minPrice != null or maxPrice != null}"
                            onclick="filterByPrice(null, null)">
                        <i class="fas fa-times"></i> 필터 초기화
                    </button>
                </div>
            </div>

            <!-- 정렬 옵션 -->
            <div class="sort-section" th:unless="${products.isEmpty()}">
                <div>
                    <span class="sort-label">정렬:</span>
                    <select class="sort-select" id="sortSelect" onchange="changeSortOrder(this.value)">
                        <option value="latest" th:selected="${sortBy == null or sortBy == 'latest'}">최신순</option>
                        <option value="price_asc" th:selected="${sortBy == 'price_asc'}">가격 낮은순</option>
                        <option value="price_desc" th:selected="${sortBy == 'price_desc'}">가격 높은순</option>
                        <option value="popular" th:selected="${sortBy == 'popular'}">인기순 (리뷰 많은순)</option>
                    </select>
                </div>
            </div>

            <!-- 상품 목록이 비어있을 때 -->
            <div class="empty-list" th:if="${products.isEmpty()}">
                <div class="empty-icon">
                    <i class="fas fa-box-open" th:if="${isSearchMode == null or !isSearchMode}"></i>
                    <i class="fas fa-search" th:if="${isSearchMode != null and isSearchMode}"></i>
                </div>
                <p class="empty-text" th:if="${isSearchMode == null or !isSearchMode}">
                    이 카테고리에는 아직 상품이 없습니다.
                </p>
                <p class="empty-text" th:if="${isSearchMode != null and isSearchMode}">
                    "<span style="color: #E31837;" th:text="${keyword}"></span>"에 대한 검색 결과가 없습니다.
                </p>
                <p th:if="${isSearchMode != null and isSearchMode}" style="font-size: 14px; color: #999; margin-bottom: 20px;">
                    다른 검색어로 다시 시도해 보세요.
                </p>
                <a th:href="@{/}" class="btn-home">
                    <i class="fas fa-home"></i> 홈으로 이동
                </a>
            </div>

            <!-- 상품 그리드 -->
            <div class="product-grid" th:unless="${products.isEmpty()}">
                <div class="product-card"
                     th:each="product : ${products}"
                     th:onclick="|location.href='@{/product/detail/{id}(id=${product.id})}'|">

                    <!-- 상품 이미지 -->
                    <div class="product-image-wrapper">
                        <!-- 할인 뱃지 -->
                        <div class="discount-badge"
                             th:if="${product.discountRate != null and product.discountRate > 0}"
                             th:text="${product.discountRate + '%'}">
                            10%
                        </div>

                        <!-- 품절 오버레이 -->
                        <div class="sold-out-overlay" th:if="${product.stockQuantity <= 0}">
                            <span class="sold-out-text">품절</span>
                        </div>

                        <img class="product-image"
                             th:src="${product.repImageUrl}"
                             th:alt="${product.productName}"
                             onerror="this.src='/images/product-sample.jpg'">
                    </div>

                    <!-- 상품 정보 -->
                    <div class="product-info">
                        <h3 class="product-name" th:text="${product.productName}">
                            상품명
                        </h3>

                        <!-- 가격 -->
                        <div class="price-section">
                            <!-- 할인이 있을 때 -->
                            <div th:if="${product.discountRate != null and product.discountRate > 0}">
                                <div class="original-price"
                                     th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                    50,000원
                                </div>
                                <div class="price-wrapper">
                                        <span class="discount-rate"
                                              th:text="${product.discountRate + '%'}">
                                            10%
                                        </span>
                                    <span class="sale-price"
                                          th:text="${#numbers.formatInteger(product.discountPrice, 0, 'COMMA') + '원'}">
                                            45,000원
                                        </span>
                                </div>
                            </div>

                            <!-- 할인이 없을 때 -->
                            <div th:unless="${product.discountRate != null and product.discountRate > 0}">
                                    <span class="regular-price"
                                          th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                        50,000원
                                    </span>
                            </div>
                        </div>

                        <!-- 재고 상태 -->
                        <div class="stock-status">
                                <span th:if="${product.stockQuantity > 10}"
                                      class="stock-available">
                                    <i class="fas fa-check-circle"></i> 재고 있음
                                </span>
                            <span th:if="${product.stockQuantity > 0 and product.stockQuantity <= 10}"
                                  class="stock-low">
                                    <i class="fas fa-exclamation-circle"></i> 재고 <span th:text="${product.stockQuantity}">5</span>개 남음
                                </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 페이지네이션 -->
            <div class="pagination-wrapper" th:if="${productPage != null and productPage.totalPages > 0}">
                <ul class="pagination">
                    <!-- 이전 버튼 -->
                    <li class="page-item" th:classappend="${productPage.first} ? 'disabled'">
                        <a class="page-link page-prev" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${productPage.number - 1}
                           )}"
                           th:if="${!productPage.first}">
                            <i class="fas fa-chevron-left"></i> 이전
                        </a>
                        <span class="page-link page-prev" th:if="${productPage.first}">
                            <i class="fas fa-chevron-left"></i> 이전
                        </span>
                    </li>
                    
                    <!-- 페이지 번호들 -->
                    <li class="page-item" 
                        th:each="pageNum : ${#numbers.sequence(0, productPage.totalPages - 1)}"
                        th:if="${pageNum >= (productPage.number - 2) and pageNum <= (productPage.number + 2)}"
                        th:classappend="${pageNum == productPage.number} ? 'active'">
                        <a class="page-link" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${pageNum}
                           )}"
                           th:text="${pageNum + 1}">1</a>
                    </li>
                    
                    <!-- 다음 버튼 -->
                    <li class="page-item" th:classappend="${productPage.last} ? 'disabled'">
                        <a class="page-link page-next" 
                           th:href="@{${isSearchMode != null and isSearchMode ? '/product/search' : '/product/list'}(
                               keyword=${keyword},
                               categoryId=${categoryId},
                               sortBy=${sortBy},
                               minPrice=${minPrice},
                               maxPrice=${maxPrice},
                               page=${productPage.number + 1}
                           )}"
                           th:if="${!productPage.last}">
                            다음 <i class="fas fa-chevron-right"></i>
                        </a>
                        <span class="page-link page-next" th:if="${productPage.last}">
                            다음 <i class="fas fa-chevron-right"></i>
                        </span>
                    </li>
                </ul>
                
                <!-- 페이지 정보 -->
                <div class="page-info">
                    <span th:text="${productPage.number + 1}">1</span> / 
                    <span th:text="${productPage.totalPages}">10</span> 페이지
                    (총 <span th:text="${productPage.totalElements}">200</span>개)
                </div>
            </div>
        </div>
    </div>
</main>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        // Thymeleaf 변수 가져오기
        const isSearchMode = /*[[${isSearchMode}]]*/ false;
        const currentKeyword = /*[[${keyword}]]*/ '';
        const currentCategoryId = /*[[${categoryId}]]*/ null;
        const currentSortBy = /*[[${sortBy}]]*/ 'latest';
        const currentMinPrice = /*[[${minPrice}]]*/ null;
        const currentMaxPrice = /*[[${maxPrice}]]*/ null;
        
        // 정렬 변경
        function changeSortOrder(sortBy) {
            let url = '';
            
            if (isSearchMode) {
                // 검색 모드
                url = '/product/search?keyword=' + encodeURIComponent(currentKeyword);
                
                if (currentCategoryId) {
                    url += '&categoryId=' + currentCategoryId;
                }
            } else {
                // 카테고리 모드
                url = '/product/list?categoryId=' + currentCategoryId;
            }
            
            url += '&sortBy=' + sortBy;
            
            if (currentMinPrice !== null) {
                url += '&minPrice=' + currentMinPrice;
            }
            
            if (currentMaxPrice !== null) {
                url += '&maxPrice=' + currentMaxPrice;
            }
            
            window.location.href = url;
        }
        
        // 가격 필터 적용
        function filterByPrice(minPrice, maxPrice) {
            let url = '';
            
            if (isSearchMode) {
                // 검색 모드
                url = '/product/search?keyword=' + encodeURIComponent(currentKeyword);
                
                if (currentCategoryId) {
                    url += '&categoryId=' + currentCategoryId;
                }
            } else {
                // 카테고리 모드
                url = '/product/list?categoryId=' + currentCategoryId;
            }
            
            url += '&sortBy=' + currentSortBy;
            
            if (minPrice !== null) {
                url += '&minPrice=' + minPrice;
            }
            
            if (maxPrice !== null) {
                url += '&maxPrice=' + maxPrice;
            }
            
            window.location.href = url;
        }
    </script>
</th:block>
</body>
</html>